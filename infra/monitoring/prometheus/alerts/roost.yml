# Roost Alert Rules
# P21.3.001: Alert Rules File
groups:
  - name: roost.streaming
    interval: 30s
    rules:
      - alert: StreamServiceDown
        expr: up{job=~"roost-.*"} == 0
        for: 2m
        labels:
          severity: critical
          team: roost
        annotations:
          summary: "Roost service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} has been unreachable for 2+ minutes."
          runbook: "https://docs.yourflock.org/roost/runbooks/service-down"

      - alert: HighStreamErrorRate
        expr: |
          rate(roost_stream_errors_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          team: roost
        annotations:
          summary: "High stream error rate: {{ $value | humanize }}/sec"
          description: "Stream errors exceeding 5/sec for 5 minutes."

      - alert: TooManyActiveStreams
        expr: roost_active_streams_total > 200
        for: 5m
        labels:
          severity: warning
          team: roost
        annotations:
          summary: "Active streams at {{ $value }} (threshold: 200)"
          description: "High concurrent stream count may indicate abuse or capacity issue."

  - name: roost.billing
    interval: 60s
    rules:
      - alert: PaymentWebhookFailures
        expr: |
          increase(roost_billing_events_total{event="webhook_failed"}[1h]) > 3
        for: 5m
        labels:
          severity: warning
          team: roost
        annotations:
          summary: "Stripe webhook failures: {{ $value }} in last hour"
          description: "Multiple Stripe webhook deliveries have failed. Check Stripe dashboard."

      - alert: SubscriberDropSignificant
        expr: |
          delta(roost_subscribers_active[1h]) < -10
        for: 1m
        labels:
          severity: warning
          team: roost
        annotations:
          summary: "Active subscriber count dropped by {{ $value | humanize }} in 1 hour"
          description: "Significant subscriber drop. Possible billing issue or churn spike."

  - name: roost.infrastructure
    interval: 60s
    rules:
      - alert: DiskSpaceWarning
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.20
        for: 5m
        labels:
          severity: warning
          team: roost
        annotations:
          summary: "Disk space below 20% on {{ $labels.instance }}"
          description: "Only {{ $value | humanizePercentage }} disk space remaining."

      - alert: DiskSpaceCritical
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.05
        for: 1m
        labels:
          severity: critical
          team: roost
        annotations:
          summary: "CRITICAL: Disk space below 5% on {{ $labels.instance }}"
          description: "Immediate action required — disk almost full."

      - alert: PostgresDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          team: roost
        annotations:
          summary: "PostgreSQL is unreachable"
          description: "postgres_exporter cannot connect to the database."

      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.90
        for: 5m
        labels:
          severity: warning
          team: roost
        annotations:
          summary: "Memory usage above 90%: {{ $value | humanizePercentage }}"
          description: "Consider scaling up the server (CX23 → CX33)."

  - name: roost.auth
    interval: 60s
    rules:
      - alert: HighLoginFailureRate
        expr: |
          rate(roost_auth_events_total{event="login",result="failed"}[5m]) > 10
        for: 3m
        labels:
          severity: warning
          team: roost
        annotations:
          summary: "High login failure rate: {{ $value | humanize }}/sec"
          description: "Possible brute-force attack. Check IP-level rate limits."
