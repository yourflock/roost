name = "roost-stream-proxy"
main = "src/index.ts"
compatibility_date = "2024-01-01"
account_id = "29537f934ea5d6cb4111472ff8728f91"

# KV namespace: active subscriber sessions (token â†’ subscriber context)
[[kv_namespaces]]
binding = "SESSIONS"
id = "PLACEHOLDER_KV_ID_SESSIONS"
preview_id = "PLACEHOLDER_KV_PREVIEW_SESSIONS"

# KV namespace: per-subscriber rate limit buckets
[[kv_namespaces]]
binding = "RATE_LIMITS"
id = "PLACEHOLDER_KV_ID_RATE_LIMITS"
preview_id = "PLACEHOLDER_KV_PREVIEW_RATE_LIMITS"

# Route: all stream traffic through this worker
[[routes]]
pattern = "stream.yourflock.org/*"
zone_name = "yourflock.org"

# Environment variables
[vars]
# Internal origin URL (never exposed to subscribers)
ROOST_ORIGIN = "http://relay:8090"
# Roost auth service for token validation
ROOST_AUTH_URL = "https://roost.yourflock.org"
# Environment identifier for health checks
ENVIRONMENT = "production"

# Cron trigger: origin health check every 30 seconds
# Note: Workers cron minimum is 1 minute; sub-minute via Durable Objects or
# Cloudflare Health Checks (configured in CF dashboard).
[[triggers.crons]]
crons = ["* * * * *"]

# Build configuration
[build]
command = "pnpm exec tsc --noEmit && echo 'TypeScript OK'"

# Development settings
[dev]
port = 8787
local_protocol = "http"
