{
  "_comment": "Cloudflare Cache Rules for Roost HLS segments — P14-T01",
  "_docs": "Apply these rules via Cloudflare Dashboard > Caching > Cache Rules, or via the Cloudflare API.",
  "_zone": "yourflock.org",
  "cache_rules": [
    {
      "name": "Cache HLS segments (.ts files)",
      "description": "Cache MPEG-TS video segments at edge for 60 seconds. Short TTL to balance freshness vs performance for live streams.",
      "expression": "(http.request.uri.path matches \"^/segments/.*\\.ts$\")",
      "action": "set_cache_settings",
      "cache_settings": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 60
        },
        "browser_ttl": {
          "mode": "override_origin",
          "default": 5
        },
        "cache_key": {
          "custom_key": {
            "query_string": {
              "exclude": ["token", "t", "sig", "auth"]
            }
          }
        },
        "origin_error_page_passthru": false,
        "respect_strong_etags": false
      }
    },
    {
      "name": "Cache HLS variant playlists (.m3u8 files)",
      "description": "Short TTL for variant playlists — they update every ~6 seconds for live streams but can be cached briefly at edge.",
      "expression": "(http.request.uri.path matches \"^/segments/.*\\.m3u8$\")",
      "action": "set_cache_settings",
      "cache_settings": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 6
        },
        "browser_ttl": {
          "mode": "override_origin",
          "default": 0
        },
        "cache_key": {
          "custom_key": {
            "query_string": {
              "exclude": ["token", "t", "sig", "auth"]
            }
          }
        },
        "origin_error_page_passthru": false,
        "respect_strong_etags": false
      }
    },
    {
      "name": "Bypass cache for stream endpoints (billing service)",
      "description": "Never cache stream authorization or billing endpoints — must always hit origin.",
      "expression": "(http.request.uri.path matches \"^/(billing|reseller|auth|admin)/.*\")",
      "action": "bypass_cache"
    },
    {
      "name": "Cache VOD segments (.ts and .mp4 fragments)",
      "description": "VOD content is immutable once uploaded — cache at edge for 24 hours.",
      "expression": "(http.request.uri.path matches \"^/vod/.*\\.(ts|mp4|m4s|m4v)$\")",
      "action": "set_cache_settings",
      "cache_settings": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 86400
        },
        "browser_ttl": {
          "mode": "override_origin",
          "default": 3600
        },
        "cache_key": {
          "custom_key": {
            "query_string": {
              "exclude": ["token", "t", "sig"]
            }
          }
        }
      }
    }
  ],
  "page_rules_deprecated": {
    "_note": "Prefer Cache Rules above (newer API). Page Rules are deprecated by Cloudflare as of 2024.",
    "_legacy_equivalent": "Cache Everything + Edge TTL 60s for /segments/*.ts"
  }
}
