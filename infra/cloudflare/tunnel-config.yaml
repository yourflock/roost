# Cloudflare Tunnel Configuration — Roost Production
#
# Privacy guarantee: this tunnel is the ONLY path from the internet to the
# Hetzner VPS. No inbound ports are open. No DNS A record points to 167.235.195.186.
# The origin IP is never published anywhere.
#
# Tunnel: roost-prod
# Created: see Cloudflare Zero Trust dashboard → Access → Tunnels
# Credentials: /etc/cloudflared/credentials.json (on VPS, from Cloudflare dashboard)
#
# Setup on VPS:
#   cloudflared service install
#   cloudflared tunnel run roost-prod
#
# The tunnel establishes 4 outbound connections to Cloudflare's edge (Ashburn
# and any 3 other PoPs for redundancy). No firewall rules needed.

tunnel: TUNNEL_ID_ROOST_PROD
credentials-file: /etc/cloudflared/credentials.json

# ---- Logging ---------------------------------------------------------------
# Log to stderr (Docker stdout → journald). Log level: error only.
# Do NOT log http_access (would capture URLs with potential token params).
loglevel: error
logfile: ""

# ---- Ingress rules ---------------------------------------------------------
# Routes traffic by hostname to the appropriate internal service.
# Order matters: first match wins.

ingress:
  # ---- Stream delivery -------------------------------------------------------
  # stream.yourflock.com — Cloudflare Worker sits in front of this.
  # The Worker validates tokens, rewrites manifest URLs, and enforces rate limits.
  # This Tunnel ingress handles the Worker → origin leg (internal only).
  - hostname: stream.yourflock.com
    service: http://relay:8090
    originRequest:
      connectTimeout: 5s
      tcpKeepAlive: 30s
      noTLSVerify: true
      # Disable HTTP keep-alive for streaming to prevent stale connections.
      keepAliveConnections: 10
      keepAliveTimeout: 90s
      # Do not follow redirects — return them to the Worker.
      noHappyEyeballs: false

  # ---- API / subscriber portal -----------------------------------------------
  # roost.yourflock.com — subscriber portal, billing, addon API.
  - hostname: roost.yourflock.com
    service: http://nginx:80
    originRequest:
      connectTimeout: 10s
      noTLSVerify: true

  # ---- Admin panel -----------------------------------------------------------
  # admin.roost.yourflock.com — internal admin UI.
  # Protected separately by Cloudflare Access (Zero Trust policy).
  - hostname: admin.roost.yourflock.com
    service: http://nginx:80
    originRequest:
      connectTimeout: 10s
      noTLSVerify: true

  # ---- Catch-all -------------------------------------------------------------
  # Return 404 for any unmatched hostname. Prevents probing.
  - service: http_status:404
