# Owl Addon API

Roost integrates with Owl via the Community Addon API. When a user adds their Roost
server URL in Owl (Settings > Sources > Add Roost), Owl fetches the manifest and
presents all available content in the unified library.

Service: `server/services/owl_api` — runs on port 8091.

## Endpoint Summary

| Method | Path | Auth | Status |
| --- | --- | --- | --- |
| `GET` | `/owl/manifest.json` | None | ✅ |
| `GET` | `/owl/version` | None | ✅ |
| `GET` | `/health` | None | ✅ |
| `POST` | `/owl/auth` | API token | ✅ |
| `GET` | `/owl/live` | Session | ✅ |
| `GET` | `/owl/epg` | Session | ✅ |
| `GET` | `/owl/epg/upcoming` | Session | ✅ |
| `POST` | `/owl/stream/:slug` | Session | ✅ |
| `GET` | `/owl/vod` | Session | ✅ |
| `GET` | `/owl/vod/:id` | Session | ✅ |
| `GET` | `/owl/v1/library` | Session | ✅ |
| `GET` | `/owl/catchup/:channel_slug` | Session | ✅ |
| `GET` | `/owl/catchup/:slug/stream` | Session | ✅ |
| `GET` | `/owl/recommendations` | Session | ✅ |

---

## Authentication

The API uses a two-step token model:

1. **API token** — long-lived token generated by the user in Roost (Settings > API Tokens).
   The user enters this in Owl once to link their account.
2. **Session token** — short-lived (4 hours) token issued by `/owl/auth`. Owl exchanges
   the API token for a session token and uses the session token for all subsequent requests.

---

## Public Endpoints (no auth required)

### `GET /owl/manifest.json`

Addon discovery document. Owl fetches this to learn the server's capabilities.

**Response:**

```json
{
  "name": "Roost",
  "version": "1.0.0",
  "description": "Self-hosted media backend",
  "auth": {
    "type": "api_token",
    "prompt": "Enter your Roost API token"
  },
  "capabilities": ["live", "vod", "epg", "catchup", "recommendations"]
}
```

### `GET /owl/version`

Version information.

```json
{ "version": "1.0.0", "api": "owl/v1" }
```

### `GET /health`

Service liveness check.

```json
{ "status": "ok", "service": "owl_api", "version": "1.0.0" }
```

---

## Session Auth

### `POST /owl/auth`

Exchange an API token for a 4-hour session token.

**Request header:**

```http
Authorization: Bearer <api_token>
```

**Response:**

```json
{
  "token": "<session_token>",
  "expires_at": "2026-02-28T18:00:00Z"
}
```

All endpoints below require `Authorization: Bearer <session_token>`.

---

## Live TV Endpoints

### `GET /owl/live`

Live channel list. Source URLs are never included — Owl calls `/owl/stream/:slug` to
get a signed, time-limited stream URL.

**Response:**

```json
[
  {
    "slug": "espn",
    "name": "ESPN",
    "number": 100,
    "group": "Sports",
    "logo_url": "https://...",
    "has_epg": true,
    "has_catchup": true
  }
]
```

### `GET /owl/epg`

EPG programs for a date window.

**Query params:** `date=YYYY-MM-DD` (default: today), `days=1–7` (default: 1)

**Response:**

```json
{
  "espn": [
    {
      "start": "2026-02-28T18:00:00Z",
      "end": "2026-02-28T20:00:00Z",
      "title": "NBA Basketball",
      "description": "...",
      "category": "Sports"
    }
  ]
}
```

### `GET /owl/epg/upcoming`

Next N programs per channel.

**Query params:** `limit=N` (default: 3 per channel)

### `POST /owl/stream/:slug`

Get a signed, time-limited HLS stream URL for a channel.

**Path param:** `slug` — channel slug from `/owl/live`

**Response:**

```json
{
  "url": "https://relay.yourdomain.com/hls/espn/index.m3u8?token=...",
  "expires_at": "2026-02-28T19:00:00Z"
}
```

Stream URLs are signed with HMAC and expire after 60 minutes. The relay service
validates the signature before serving segments.

---

## VOD Endpoints

### `GET /owl/vod`

VOD catalog (movies and series).

**Query params:** `type=movie|series`, `page=N`, `limit=N` (default: 50)

**Response:**

```json
[
  {
    "id": "tt1234567",
    "type": "movie",
    "title": "Example Movie",
    "year": 2024,
    "poster_url": "https://...",
    "genres": ["Drama"],
    "rating": 7.8
  }
]
```

### `GET /owl/vod/:id`

Content details, stream URL, and watch progress.

**Response:**

```json
{
  "id": "tt1234567",
  "title": "Example Movie",
  "stream_url": "https://...",
  "watch_progress": 1234,
  "subtitles": [...]
}
```

---

## Library Endpoint

### `GET /owl/v1/library`

Unified paginated catalog across all non-live content types: movies, series, music,
podcasts, and games. Owl uses this to populate the Library tab for the Roost addon.

**Query params:**

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| `type` | string | all | Filter: `movie`, `series`, `music`, `podcast`, `game` |
| `q` | string | — | Full-text search across title/name |
| `limit` | integer | 50 | Page size (max 200) |
| `offset` | integer | 0 | Pagination offset |

**Response:**

```json
{
  "items": [
    {
      "id": "tt1234567",
      "type": "movie",
      "title": "Inception",
      "description": "...",
      "cover_url": "https://...",
      "year": 2010,
      "genres": ["Action", "Sci-Fi"],
      "stream_url": "https://relay.yourdomain.com/...",
      "stream_expiry": "2026-02-28T19:00:00Z",
      "metadata": { "duration_seconds": 8880, "tmdb_score": 8.8 }
    }
  ],
  "total": 1,
  "limit": 50,
  "offset": 0,
  "type_counts": { "movie": 200, "series": 80, "music": 40, "podcast": 12, "game": 35 },
  "updated_at": "2026-02-28T18:00:00Z"
}
```

Stream URLs are HMAC-signed with a 15-minute TTL. Series, podcasts, and multi-episode
content return a browse URL instead of a direct stream URL.

---

## Catchup Endpoints

### `GET /owl/catchup/:channel_slug`

Available catchup hours for a channel (up to 7 days).

**Response:**

```json
{
  "channel": "espn",
  "available_hours": 72,
  "oldest_available": "2026-02-21T00:00:00Z"
}
```

### `GET /owl/catchup/:slug/stream`

Catchup stream URL for a time range.

**Query params:** `start=ISO8601`, `end=ISO8601`

**Response:** Same shape as `/owl/stream/:slug`.

---

## Recommendations

### `GET /owl/recommendations`

Personalized content recommendations based on watch history.

**Response:**

```json
[
  {
    "id": "tt1234567",
    "type": "movie",
    "title": "...",
    "reason": "Because you watched X"
  }
]
```

---

## Error Responses

All endpoints return standard error shapes:

```json
{ "error": "unauthorized", "message": "Invalid or expired token" }
```

| HTTP Status | Error | Meaning |
| --- | --- | --- |
| 401 | `unauthorized` | Invalid or expired token |
| 403 | `forbidden` | Token valid but no access to this resource |
| 404 | `not_found` | Channel or content not found |
| 429 | `rate_limited` | Too many requests (Redis rate limiting) |
| 500 | `internal_error` | Server error |
