name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ─────────────────────────────────────────────
  # Go — test all server services
  # ─────────────────────────────────────────────

  test-go:
    name: Test / Go server
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: roost_test
          POSTGRES_PASSWORD: roost_test
          POSTGRES_DB: roost_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    env:
      DATABASE_URL: postgresql://roost_test:roost_test@localhost:5433/roost_test
      BILLING_PORT: "18085"
      INGEST_PORT: "18094"
      RELAY_PORT: "18090"
      CATALOG_PORT: "18095"
      EPG_PORT: "18096"
      OWL_API_PORT: "18091"
      STRIPE_SECRET_KEY: sk_test_dummy_for_ci
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: server/go.sum
      - name: Run migrations (test DB)
        run: |
          for f in $(ls server/db/migrations/*.sql | sort); do
            PGPASSWORD=roost_test psql \
              -h localhost -p 5433 -U roost_test -d roost_test \
              -f "$f" 2>/dev/null || true
          done
      - name: Test all services
        working-directory: server
        run: go test ./... -v -timeout 120s -count=1
      - name: Vet
        working-directory: server
        run: go vet ./...

  build-go:
    name: Build / Go services (validate compilation)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - ingest
          - relay
          - catalog
          - epg
          - owl_api
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: server/go.sum
      - name: Build ${{ matrix.service }}
        working-directory: server
        run: |
          if [ -d "services/${{ matrix.service }}/cmd/${{ matrix.service }}" ]; then
            go build ./services/${{ matrix.service }}/cmd/${{ matrix.service }}/...
          elif [ -d "services/${{ matrix.service }}/cmd" ]; then
            go build ./services/${{ matrix.service }}/cmd/...
          else
            go build ./services/${{ matrix.service }}/...
          fi

  build-go-billing:
    name: Build / Go billing service
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: server/go.sum
      - name: Build billing
        working-directory: server
        run: |
          if [ -f "services/billing/main.go" ]; then
            go build ./services/billing/...
          elif [ -d "services/billing/cmd" ]; then
            go build ./services/billing/cmd/...
          else
            go build ./services/billing/...
          fi

  # ─────────────────────────────────────────────
  # Docker — build image check (no push on CI)
  # ─────────────────────────────────────────────

  docker-build:
    name: Docker build check
    runs-on: ubuntu-latest
    needs:
      - test-go
      - build-go
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: server/Dockerfile
          push: false
          tags: ghcr.io/unyeco/roost:ci-${{ github.sha }}
          build-args: VERSION=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
