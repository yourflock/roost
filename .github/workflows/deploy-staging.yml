name: Deploy — Staging

on:
  push:
    branches:
      - develop

# Only allow one staging deploy at a time. Cancel in-progress if new push arrives.
concurrency:
  group: deploy-staging
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  ORG: yourflock

jobs:

  # ─────────────────────────────────────────────
  # 1. Build and push Docker images
  # ─────────────────────────────────────────────

  build-push-images:
    name: Build & push / ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - ingest
          - relay
          - catalog
          - epg
          - owl_api
          - billing
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/roost-${{ matrix.service }}:develop
            ${{ env.REGISTRY }}/${{ env.ORG }}/roost-${{ matrix.service }}:sha-${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ─────────────────────────────────────────────
  # 2. Deploy to staging via SSH
  # ─────────────────────────────────────────────

  deploy:
    name: Deploy to staging
    runs-on: ubuntu-latest
    needs: build-push-images
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.ROOST_STAGING_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -euo pipefail
            cd /opt/roost

            echo "Deploying sha-${{ github.sha }} to staging..."

            IMAGE_TAG="sha-${{ github.sha }}" \
              docker compose -f infra/staging/docker-compose.staging.yml pull

            IMAGE_TAG="sha-${{ github.sha }}" \
              docker compose -f infra/staging/docker-compose.staging.yml up -d \
                --remove-orphans

            echo "Waiting for services to start..."
            sleep 15

            # Smoke test all service health endpoints
            FAILED=0
            for service_port in "billing:8085" "ingest:8094" "relay:8090" "catalog:8095" "epg:8096" "owl_api:8091"; do
              name="${service_port%%:*}"
              port="${service_port##*:}"
              if wget --quiet --tries=3 --timeout=10 -O /dev/null \
                  "http://localhost:${port}/health" 2>/dev/null; then
                echo "  [OK] $name"
              else
                echo "  [FAIL] $name (port $port)"
                FAILED=1
              fi
            done

            if [ "$FAILED" -eq 1 ]; then
              echo "Smoke test failed — rolling back."
              IMAGE_TAG="develop" \
                docker compose -f infra/staging/docker-compose.staging.yml up -d
              exit 1
            fi

            echo "Staging deploy complete."

  # ─────────────────────────────────────────────
  # 3. Post deploy status
  # ─────────────────────────────────────────────

  notify:
    name: Notify result
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Report deploy outcome
        shell: bash
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "Staging deploy succeeded for sha ${{ github.sha }}."
          else
            echo "Staging deploy FAILED for sha ${{ github.sha }}."
            exit 1
          fi
